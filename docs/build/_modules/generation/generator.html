<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>generation.generator &mdash; ESR 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> ESR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ESR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>generation.generator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for generation.generator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">sympy</span>
<span class="kn">from</span> <span class="nn">sympy.core.sympify</span> <span class="kn">import</span> <span class="n">kernS</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>

<span class="kn">import</span> <span class="nn">esr.generation.simplifier</span> <span class="k">as</span> <span class="nn">simplifier</span>
<span class="kn">import</span> <span class="nn">esr.generation.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">esr.fitting.sympy_symbols</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>

<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../api.html#generation.generator.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="Node.copy"><a class="viewcode-back" href="../../api.html#generation.generator.Node.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span>
        <span class="k">return</span> <span class="n">new_node</span></div>
        
<div class="viewcode-block" id="Node.is_used"><a class="viewcode-back" href="../../api.html#generation.generator.Node.is_used">[docs]</a>    <span class="k">def</span> <span class="nf">is_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Node.assign_op"><a class="viewcode-back" href="../../api.html#generation.generator.Node.assign_op">[docs]</a>    <span class="k">def</span> <span class="nf">assign_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">op</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div></div>
            
<div class="viewcode-block" id="DecoratedNode"><a class="viewcode-back" href="../../api.html#generation.generator.DecoratedNode">[docs]</a><span class="k">class</span> <span class="nc">DecoratedNode</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">parent_op</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">is_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_op</span> <span class="o">=</span> <span class="n">parent_op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fun</span><span class="o">.</span><span class="n">is_symbol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Pow&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;Square&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Pow&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;Cube&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Pow&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;Sqrt&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Mul&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Pow&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;Div&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">),</span>
                            <span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Pow&#39;</span> <span class="ow">and</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;Inv&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">as_two_terms</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">),</span>
                                <span class="n">DecoratedNode</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecoratedNode</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">parent_op</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fun</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
                
<div class="viewcode-block" id="DecoratedNode.is_unity"><a class="viewcode-back" href="../../api.html#generation.generator.DecoratedNode.is_unity">[docs]</a>    <span class="k">def</span> <span class="nf">is_unity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
            
<div class="viewcode-block" id="DecoratedNode.count_nodes"><a class="viewcode-back" href="../../api.html#generation.generator.DecoratedNode.count_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">count_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        
        <span class="c1"># Sqrt(x) instead of pow(x, 1/2)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">Half</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;sqrt&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;sqrt_abs&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Square(x) instead of pow(x, 2)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;square&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="c1"># Cube(x) instead of pow(x, 3)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;cube&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Inv(x) instead of pow(x, -1)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;inv&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_op</span> <span class="o">==</span> <span class="s2">&quot;Mul&quot;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>
                
        <span class="c1"># Multiply or divide by one doesn&#39;t do anything</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Mul&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_unity</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_unity</span><span class="p">()):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Div&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Treat sqrt_abs and pow_abs as a single function</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Abs&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="n">carr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">v</span> <span class="o">+</span> <span class="n">carr</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="DecoratedNode.to_list"><a class="viewcode-back" href="../../api.html#generation.generator.DecoratedNode.to_list">[docs]</a>    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span><span class="p">]</span>
        <span class="c1"># Sqrt(x) instead of pow(x, 1/2)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">Half</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;sqrt&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;sqrt_abs&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;sqrt&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;sqrt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;sqrt_abs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Square(x) instead of pow(x, 2)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;square&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Cube(x) instead of pow(x, 3)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;cube&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;cube&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Inv(x) instead of pow(x, -1)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;inv&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Inv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Deal with * inv = /</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Mul&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Mul&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Deal with / inv = *</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Div&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Pow&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">numbers</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Mul&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Multiply or divide by one doesn&#39;t do anything</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Mul&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_unity</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_unity</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_unity</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="c1"># Don&#39;t keep abs after pow or sqrt</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Abs&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Sqrt&quot;</span><span class="p">,</span> <span class="s2">&quot;Pow&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;Div&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span></div></div>

        
<div class="viewcode-block" id="check_tree"><a class="viewcode-back" href="../../api.html#generation.generator.check_tree">[docs]</a><span class="k">def</span> <span class="nf">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given a candidate string of 0, 1 and 2s, see whether one can make a function out of this</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :s (str): string comprised of 0, 1 and 2 representing tree of nullary, unary and binary nodes</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :success (bool): whether candidate string can form a valid tree (True) or not (False)</span>
<span class="sd">        :part_considered (str): string of length &lt;= s, where s[:len(part_considered)] = part_considered</span>
<span class="sd">        :tree (list): list of Node objects corresponding to string s</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Add to the left if possible</span>
            <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># try to go up the tree</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
            
            <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            
                <span class="k">if</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># Add to right of node if possible</span>
                    <span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># Check if can&#39;t move up the tree any higher</span>
                    <span class="k">break</span>
                
                <span class="c1"># Go up the tree to this node&#39;s parent</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
                
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">break</span>
            
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            
        <span class="c1"># Need to check for parents without left nodes which should have them</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">lefts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">left</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">lefts</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Need to check for parents without right nodes which should have them</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">rights</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">right</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">rights</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                
        <span class="c1"># This will allow us to delete any trees which start with this</span>
        <span class="n">part_considered</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">part_considered</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">part_considered</span><span class="p">,</span> <span class="n">tree</span></div>
            
        
<div class="viewcode-block" id="get_allowed_shapes"><a class="viewcode-back" href="../../api.html#generation.generator.get_allowed_shapes">[docs]</a><span class="k">def</span> <span class="nf">get_allowed_shapes</span><span class="p">(</span><span class="n">compl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Find the shapes of all allowed trees containing compl nodes</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :compl (int): complexity of tree = number of nodes</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :cand (list): list of strings comprised of 0, 1 and 2 representing valid trees of nullary, unary and binary nodes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Make all graphs with this complexity</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="s1">&#39;012&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">compl</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Graph cannot start with a type0 node</span>
        <span class="k">if</span> <span class="n">compl</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="n">cand</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Graph must end at a type0 node</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="n">cand</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># The penultimate node cannot be of type2</span>
        <span class="k">if</span> <span class="n">cand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="n">cand</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">msk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msk</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">part_considered</span><span class="p">,</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">msk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Remove other candidates where this string appears at the start</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[:,:</span><span class="nb">len</span><span class="p">(</span><span class="n">part_considered</span><span class="p">)]</span> <span class="o">==</span> <span class="n">part_considered</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">msk</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">cand</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="n">msk</span><span class="p">,:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cand</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">cand</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">cand</span></div>
    
    
<div class="viewcode-block" id="node_to_string"><a class="viewcode-back" href="../../api.html#generation.generator.node_to_string">[docs]</a><span class="k">def</span> <span class="nf">node_to_string</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a tree with labels into a string giving function</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :idx (int): index of tree to consider</span>
<span class="sd">        :tree (list): list of Node objects corresponding to the tree</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Function as a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;0&#39;</span>
    <span class="k">elif</span> <span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">node_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">elif</span> <span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">node_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">node_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">node_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">node_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">return</span></div>
    
    
<div class="viewcode-block" id="string_to_expr"><a class="viewcode-back" href="../../api.html#generation.generator.string_to_expr">[docs]</a><span class="k">def</span> <span class="nf">string_to_expr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">kern</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a string giving function into a sympy object</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :s (str): string representation of the function considered</span>
<span class="sd">        :kern (bool): whether to use sympy&#39;s kernS function or sympify</span>
<span class="sd">        :evaluate (bool): whether to use powsimp, factor and subs</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :expr (sympy object): expression corresponding to s</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*^&#39;</span><span class="p">,</span> <span class="s1">&#39;*10^&#39;</span><span class="p">)</span>
    
    <span class="n">locs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inv&quot;</span><span class="p">:</span> <span class="n">inv</span><span class="p">,</span>
            <span class="s2">&quot;square&quot;</span><span class="p">:</span> <span class="n">square</span><span class="p">,</span>
            <span class="s2">&quot;cube&quot;</span><span class="p">:</span> <span class="n">cube</span><span class="p">,</span>
            <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">log</span><span class="p">,</span>
            <span class="s2">&quot;pow&quot;</span><span class="p">:</span> <span class="nb">pow</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span>
            <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">kern</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">kernS</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
<span class="c1">#        expr = sympy.sympify(s, evaluate=evaluate,</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
                            <span class="nb">locals</span><span class="o">=</span><span class="n">locs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">evaluate</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">powsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">factor</span><span class="p">()</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">expr</span></div>
    
    
<div class="viewcode-block" id="string_to_node"><a class="viewcode-back" href="../../api.html#generation.generator.string_to_node">[docs]</a><span class="k">def</span> <span class="nf">string_to_node</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a string giving function into a tree with labels</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :s (str): string representation of the function considered</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :tree (list): list of Node objects corresponding to the tree</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">expr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_to_expr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">kern</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DecoratedNode</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_to_expr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">kern</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DecoratedNode</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_to_expr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">kern</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DecoratedNode</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    
    <span class="c1"># FINISH THIS OFF</span>

    <span class="k">return</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>
    
    
<div class="viewcode-block" id="update_tree"><a class="viewcode-back" href="../../api.html#generation.generator.update_tree">[docs]</a><span class="k">def</span> <span class="nf">update_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">try_idx</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to combine exponentials and powers to make simpler representations of functions</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :tree (list): list of Node objects corresponding to tree of function</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">        :try_idx (int): when we have multiple substituions we can attempt, this indicates which one to try</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :new_labels (list): list of strings giving node labels of new tree</span>
<span class="sd">        :new_shape (list): list of 0, 1 and 2 representing whether nodes in new tree are nullary, unary or binary</span>
<span class="sd">        :nadded (int): number of new functions added</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pow_set</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt_abs&quot;</span><span class="p">,</span> <span class="s2">&quot;inv&quot;</span><span class="p">]</span>
    <span class="n">pow_num</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;square&quot;</span><span class="p">:</span><span class="s1">&#39;*2&#39;</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span><span class="s1">&#39;*3&#39;</span><span class="p">,</span> <span class="s2">&quot;sqrt_abs&quot;</span><span class="p">:</span><span class="s1">&#39;/2&#39;</span><span class="p">,</span> <span class="s2">&quot;inv&quot;</span><span class="p">:</span><span class="s1">&#39;*-1&#39;</span><span class="p">}</span>
    <span class="n">exp_set</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;log_abs&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;pow_abs&quot;</span><span class="p">]</span>
    <span class="c1"># log_abs comes first, exp comes second, pow_abs can go in either order</span>
    <span class="n">exp_ord</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;log_abs&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pow_abs&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
    
    <span class="n">common_pow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">pow_set</span><span class="p">))</span>
    <span class="n">common_exp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">exp_set</span><span class="p">))</span>
    
    <span class="n">special_idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">diff1_idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">diff2_idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num2</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># See if we have any of the correct patterns in the labels list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_pow</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_exp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">common_exp</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">common_pow</span><span class="p">):</span>
                        <span class="n">special_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;*1&#39;</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span><span class="p">):</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">common_pow</span><span class="p">:</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">+=</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">diff1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">diff2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        
                        <span class="n">n</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
                        <span class="n">num1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="n">num2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            
                <span class="k">if</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">common_pow</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">special_idx</span><span class="p">:</span>
                            <span class="n">special_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;*1&#39;</span>
                        <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="n">common_pow</span><span class="p">:</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                                <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                                    <span class="n">s</span> <span class="o">+=</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">pow_num</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">]][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff2_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">special_idx</span><span class="p">):</span>
                            <span class="n">diff1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">diff2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diff2_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">num2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">special_idx</span><span class="p">):</span>
                            <span class="n">num1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="n">num2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">num2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                               
    <span class="n">new_shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nadded</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">special_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">try_idx</span><span class="p">:</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">special_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">num1</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">diff1_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">num2</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">diff2_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">num1</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">num2</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">diff1_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">diff2_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">n2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            
            <span class="c1"># Combine the two numbers</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;*1&#39;</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">n1</span>
            <span class="k">if</span> <span class="n">n2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">n2</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="p">)</span>
            
            <span class="n">orig_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">])</span>
            <span class="n">orig_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">]</span>
            
            <span class="c1"># Start of exponent</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
            
            <span class="c1"># End of exponent</span>
            <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
                
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="c1"># First part of tree (up to the d2 operators which make number)</span>
                    <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d2</span><span class="p">]</span> <span class="o">+</span>
                    <span class="c1"># The pow comes next</span>
                    <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                    <span class="c1"># Skip the d1 operators which give the number</span>
                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d2</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="c1"># First part of tree (up to the d2 operators which make number)</span>
                        <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d2</span><span class="p">]</span> <span class="o">+</span>
                        <span class="c1"># The pow comes next</span>
                        <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                        <span class="c1"># Skip the d2 operators which give the number</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                        <span class="c1"># Add in a * or /</span>
                        <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                        <span class="c1"># The original exponent on left of * or /</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span>
                        <span class="c1"># Put number at right of * or /</span>
                        <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span>
                        <span class="c1"># Rest of tree</span>
                        <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
                        <span class="p">)</span>
                <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                        <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">orig_shape</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">orig_shape</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
            
            <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>

            <span class="n">orig_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">])</span>
            <span class="n">orig_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;*-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">inv_op</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;+&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inv_op</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="c1"># First part of tree</span>
                                <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">inv_op</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># Left part of + unchanged</span>
                                <span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># Skip the d operators which give the number</span>
                                <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">orig_shape</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="c1"># First part of tree</span>
                                <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">inv_op</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># Left part of + unchanged</span>
                                <span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># Add * or / to right of +</span>
                                <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                                <span class="c1"># Put &quot;log_abs&quot; at left of * or /</span>
                                <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                <span class="c1"># Skip the d operators which give the number</span>
                                <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># Put number at right of * or / and add rest of tree</span>
                                <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                                <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="n">orig_shape</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">orig_shape</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                    
                    <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                <span class="k">elif</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inv_op</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                
                    <span class="c1"># Index of where right side of + ends</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span> <span class="o">+</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="c1"># First part of tree</span>
                            <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">inv_op</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Move right part of + to the left</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Put &quot;log_abs&quot; at start of right of +</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Skip the d operators which give the number</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Rest of tree</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
                            <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="c1"># First part of tree</span>
                            <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">inv_op</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Move right part of + to the left</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Add * or / to right of +</span>
                            <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                            <span class="c1"># Put &quot;log_abs&quot; at left of * or /</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Skip the d operators which give the number</span>
                            <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span> <span class="o">+</span>
                            <span class="c1"># Put number at right of * or / and add rest of tree</span>
                            <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
                            <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">tree</span><span class="p">[</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span> <span class="o">+</span> \
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">orig_shape</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
                      
                    <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># TWO CASES:</span>
                    <span class="c1"># (1) F - G -&gt; (-1)*(n * H + G) /</span>
                    <span class="c1"># (2) F - G -&gt; (-n)*H - G</span>
                    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">inv_op</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="c1"># First part of tree</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># Add *(-1) before + or -</span>
                                    <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="n">inv_op</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># * or / the first term</span>
                                    <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span> <span class="o">+</span>
                                    <span class="c1"># Put &quot;log_abs&quot; at right of * or /</span>
                                    <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># Skip the d operators which give the number</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">orig_shape</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="c1"># First part of tree</span>
                                <span class="n">labels</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                <span class="c1"># * or / the first term</span>
                                <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span>
                                <span class="c1"># Put &quot;log_abs&quot; at right of * or /</span>
                                <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                <span class="c1"># Skip the d operators which give the number</span>
                                <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="p">)</span>
                    <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">orig_shape</span><span class="p">[:</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="p">)</span>
                    <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="c1"># First part of tree</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># Skip the d operators which give the number</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="c1"># First part of tree</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># * or / the &quot;log_abs&quot;</span>
                                    <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># Put &quot;log_abs&quot; at left of tree</span>
                                    <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># Skip the d operators which give the number</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># Put number at right of * or /</span>
                                    <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span>
                                    <span class="c1"># Rest of tree</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">exp_ord</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="c1"># First part of tree (up to the d operators which make number)</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># The rest of the tree</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="c1"># First part of tree (up to the d operators which make number)</span>
                                    <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># The exp comes next</span>
                                    <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># * or / the argument of &quot;exp&quot;</span>
                                    <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                                    <span class="c1"># First part of argument of &quot;exp&quot; on left of * or /</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                                    <span class="c1"># Put number at right of * or /</span>
                                    <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span>
                                    <span class="c1"># Rest of tree</span>
                                    <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                                    <span class="p">)</span>
                        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">orig_shape</span><span class="p">[:</span><span class="n">i</span><span class="o">-</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="n">orig_shape</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
                
                <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">nadded</span></div>


<div class="viewcode-block" id="update_sums"><a class="viewcode-back" href="../../api.html#generation.generator.update_sums">[docs]</a><span class="k">def</span> <span class="nf">update_sums</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">try_idx</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to combine sums to make simpler representations of functions</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :tree (list): list of Node objects corresponding to tree of function</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">        :try_idx (int): when we have multiple substituions we can attempt, this indicates which one to try</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :new_labels (list): list of strings giving node labels of new tree</span>
<span class="sd">        :new_shape (list): list of 0, 1 and 2 representing whether nodes in new tree are nullary, unary or binary</span>
<span class="sd">        :nadded (int): number of new functions added</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nadded</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">nadded</span>
        
    <span class="c1"># Find all the +s or -s which aren&#39;t children of other +s or -s</span>
    <span class="n">plus_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">or</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span>
    <span class="n">plus_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">plus_idx</span> <span class="k">if</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">])]</span>
    
    <span class="k">if</span> <span class="n">try_idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus_idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">nadded</span>
        
    <span class="n">i</span> <span class="o">=</span> <span class="n">plus_idx</span><span class="p">[</span><span class="n">try_idx</span><span class="p">]</span>
    <span class="n">orig_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">])</span>
    <span class="n">orig_parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c1"># Find all terms in sum (sometimes this happens over multiple layers of tree if nested +s or -s)</span>
    <span class="k">def</span> <span class="nf">get_sum</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">run_anyway</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">run_anyway</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]:</span>
            <span class="n">sum_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">get_sum</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">sum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                        <span class="n">sum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">get_sum</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">sum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                        <span class="n">sum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">temp_list</span><span class="p">,</span> <span class="n">temp_idx</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">get_sum</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">sum_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">]:</span>
                    <span class="n">sum_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                    <span class="n">idx_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">sum_list</span> <span class="o">+=</span> <span class="n">s</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                        <span class="n">idx_list</span> <span class="o">+=</span> <span class="n">temp_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">temp_list</span><span class="p">,</span> <span class="n">temp_idx</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">get_sum</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r2</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">sum_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)):</span>
                <span class="n">temp_idx</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">]:</span>
                    <span class="n">sum_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                    <span class="n">idx_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">temp_list</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">sum_list</span> <span class="o">+=</span> <span class="n">s</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
                        <span class="n">idx_list</span> <span class="o">+=</span> <span class="n">temp_idx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sum_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">sum_list</span><span class="p">,</span> <span class="n">idx_list</span><span class="p">,</span> <span class="n">r</span>
    
    <span class="c1"># run_anyway checks to see if we have any 0* in the sum</span>
    <span class="c1"># this won&#39;t show up in all_s, but means we will want to</span>
    <span class="c1"># try to rewrite this sum</span>
    <span class="n">all_s</span><span class="p">,</span> <span class="n">all_idx</span><span class="p">,</span> <span class="n">run_anyway</span> <span class="o">=</span> <span class="n">get_sum</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">all_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">all_idx</span><span class="p">]</span>
    <span class="n">orig_parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">]</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span> <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="c1">#p</span>
    <span class="n">last_child</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">last_child</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orig_parents</span><span class="p">[</span><span class="n">last_child</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="c1">#p</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">end_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">last_child</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="c1"># Work out the signs of each term in the sum</span>
    <span class="n">all_sign</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">neg_const</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">orig_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_start</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">all_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">neg_const</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">neg_const</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">neg_const</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">all_idx</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">while</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">right</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">elif</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">right</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">n</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">neg_const</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">all_sign</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># Get unique terms in sum</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">all_s</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ss</span><span class="p">)))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    
    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_s</span><span class="p">))</span> <span class="ow">or</span> <span class="n">run_anyway</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                
            <span class="n">l</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[:</span><span class="n">i</span><span class="p">]]</span>

            <span class="n">rep</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_s</span><span class="p">))</span> <span class="k">if</span> <span class="n">all_s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">rep_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">all_sign</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rep</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_s</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>

            <span class="c1"># Add the unique stuff</span>
            <span class="c1"># Always adding to the right</span>
            <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">n_uni</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">uni</span><span class="p">:</span>
                <span class="n">nrep</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_sign</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_sign</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">all_s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_s</span><span class="p">[</span><span class="n">b</span><span class="p">])]</span>
                <span class="n">len_nrep</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span>
                <span class="n">nrep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">neg_const</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">len_nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># If neg_const try to get the version with the - instead of + (or vice versa)</span>
                    <span class="n">left_idx</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">left</span>
                    <span class="n">right_idx</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">right</span>
                    <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                            <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrep</span><span class="p">)]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                            <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="p">]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                        <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="k">elif</span> <span class="n">right_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                        <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">right_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">right_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                            <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">right_idx</span><span class="p">]</span> <span class="o">+</span> \
                                    <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                    <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">right_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="p">]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="k">if</span> <span class="n">all_sign</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">all_sign</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrep</span><span class="p">)]</span> <span class="o">+</span> \
                                <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>

                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                    <span class="k">if</span> <span class="n">nrep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
                        
            <span class="n">l_rep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">t_rep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rep_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                
                <span class="k">if</span> <span class="n">rep_val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">l_rep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep_val</span><span class="p">)]</span>
                    <span class="n">t_rep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                    <span class="n">l_rep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="p">])</span>
                    <span class="n">t_rep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="p">])]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_uni</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">l_uni</span> <span class="o">+</span> <span class="n">l_rep</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">t_uni</span> <span class="o">+</span> <span class="n">t_rep</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="n">l_rep</span> <span class="o">+</span> <span class="n">l_uni</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_rep</span> <span class="o">+</span> <span class="n">t_uni</span>
                    
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1"># Now remove the +/- 0</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">n_uni</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">n_uni</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">l_uni</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_uni</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n_uni</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">):</span>
                        <span class="c1">#If all the things added are negative, we can change the top node</span>
                        <span class="c1"># and make them all +&#39;s provided they are on the right of that node</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">l_uni</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_uni</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Otherwise we can move the right hand side of one of the + nodes</span>
                        <span class="c1"># down to bottom left to terminate the tree</span>
                        <span class="n">plus_idx</span> <span class="o">=</span> <span class="n">n_uni</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
                        <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">n_uni</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uni</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">plus_idx</span><span class="p">:</span>
                                <span class="n">a</span> <span class="o">=</span> <span class="n">uni</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="n">nrep</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_sign</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_sign</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">all_s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_s</span><span class="p">[</span><span class="n">b</span><span class="p">])]</span>
                                <span class="n">nrep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">neg_const</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="c1"># If neg_const try to get the version with the - instead of + (or vice versa)</span>
                                    <span class="n">left_idx</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">left</span>
                                    <span class="n">right_idx</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">right</span>
                                    <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                                        <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                            <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                        <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrep</span><span class="p">)]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                            <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)):</span>
                                            <span class="n">x</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                            <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                                        <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="k">elif</span> <span class="n">right_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                                        <span class="n">labels</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">left_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">x</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">right_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">right_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                            <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                                <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">right_idx</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                                        <span class="n">labels</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                                <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">right_idx</span><span class="p">]]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                                        <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">right_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="p">]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="k">if</span> <span class="n">all_sign</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">all_sign</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrep</span><span class="p">)]</span> <span class="o">+</span> \
                                                <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">l_uni</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span>
                                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">l_uni</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nrep</span><span class="p">))]</span> <span class="o">+</span> \
                                                <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                                        <span class="n">t_uni</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span>

                                    <span class="k">if</span> <span class="n">nrep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">nrep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">n_uni</span> <span class="o">=</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>
                                        
                        <span class="n">a</span> <span class="o">=</span> <span class="n">uni</span><span class="p">[</span><span class="n">plus_idx</span><span class="p">]</span>
                        <span class="n">nrep</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_sign</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_sign</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="n">all_s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">all_s</span><span class="p">[</span><span class="n">b</span><span class="p">])]</span>
                        <span class="n">nrep</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">n_uni</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrep</span><span class="p">)]</span> <span class="o">+</span> \
                                <span class="n">labels</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">l_uni</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_uni</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
                                <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">all_idx</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> <span class="n">t_uni</span>
            
            <span class="n">l</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tt</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="n">end_idx</span><span class="p">:]]</span>
            <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">nadded</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">nadded</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_shape</span> <span class="o">=</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">nadded</span></div>
    
    
<div class="viewcode-block" id="find_additional_trees"><a class="viewcode-back" href="../../api.html#generation.generator.find_additional_trees">[docs]</a><span class="k">def</span> <span class="nf">find_additional_trees</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For a given tree, try to find all simpler representations of the function by combining sums, exponentials and powers</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :tree (list): list of Node objects corresponding to tree of function</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :new_tree (list): list of equivalent trees, given as lists of Node objects</span>
<span class="sd">        :new_labels (list): list of lists of strings giving node labels of new_tree</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_tree</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">]</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">]</span>
    <span class="n">try_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">old_len</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Try log, exp and sqrt changes</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span> <span class="o">!=</span> <span class="n">old_len</span><span class="p">:</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">old_len</span><span class="p">):</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">update_tree</span><span class="p">(</span><span class="n">new_tree</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">try_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">basis_functions</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">try_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                            <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">try_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">try_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c1"># Try sum changes</span>
    <span class="n">try_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">try_idx</span><span class="p">)</span>
    <span class="n">old_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span> <span class="o">!=</span> <span class="n">old_len</span><span class="p">:</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">old_len</span><span class="p">):</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">update_sums</span><span class="p">(</span><span class="n">new_tree</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">try_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">basis_functions</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">max_param</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)]))</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">)]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">sym</span> <span class="o">=</span> <span class="n">simplifier</span><span class="o">.</span><span class="n">initial_sympify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">max_param</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maybe bad (not keeping):&#39;</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                            <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                            <span class="n">try_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed sympy (not keeping):&#39;</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">max_param</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)]))</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_</span><span class="p">,</span> <span class="n">sym</span> <span class="o">=</span> <span class="n">simplifier</span><span class="o">.</span><span class="n">initial_sympify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">max_param</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="c1">#if not sym[0].equals(sym[1]):</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maybe bad (not keeping):&#39;</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sym</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                                    <span class="n">new_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                                    <span class="n">try_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed sympy (not keeping):&#39;</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                                
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">try_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">new_tree</span><span class="p">,</span> <span class="n">new_labels</span></div>
    
    
<div class="viewcode-block" id="shape_to_functions"><a class="viewcode-back" href="../../api.html#generation.generator.shape_to_functions">[docs]</a><span class="k">def</span> <span class="nf">shape_to_functions</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find all possible functions formed from the given list of 0s, 1s and 2s defining a tree and basis functions</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :s (str): string comprised of 0, 1 and 2 representing tree of nullary, unary and binary nodes</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :all_fun (list): list of strings containing all functions generated directly from tree</span>
<span class="sd">        :all_tree (list): list of lists of Node objects corresponding to the trees of functions in all_fun</span>
<span class="sd">        :extra_fun (list): list of strings containing functions generated by combining sums, exponentials and powers of the functions in all_fun</span>
<span class="sd">        :extra_tree (list): list of lists of Node objects corresponding to the trees of functions in extra_fun</span>
<span class="sd">        :extra_orig (list): list of strings corresponding to original versions of extra_fun, as found in all_fun</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">t0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">repeat</span> <span class="o">=</span> <span class="n">n0</span><span class="p">)]</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">repeat</span> <span class="o">=</span> <span class="n">n1</span><span class="p">)]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">repeat</span> <span class="o">=</span> <span class="n">n2</span><span class="p">)]</span>
    
    <span class="c1"># Rename parameters so appear in order</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
            <span class="n">t0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;a</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">j</span>
    
    <span class="n">success</span><span class="p">,</span> <span class="n">part_considered</span><span class="p">,</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">check_tree</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="n">all_fun</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">all_tree</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_tree</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;U100&#39;</span><span class="p">)</span>
    <span class="n">m0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
    
    <span class="n">extra_tree</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extra_fun</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extra_orig</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">split_idx</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">),</span> <span class="n">rank</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> 
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t0</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t2</span><span class="p">)):</span>
            
                <span class="n">labels</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">m0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">m1</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">m2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span>

                <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">all_tree</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">all_fun</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">imin</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">imax</span><span class="p">):</span>
                    <span class="n">new_tree</span><span class="p">,</span> <span class="n">new_labels</span> <span class="o">=</span> <span class="n">find_additional_trees</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">basis_functions</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)):</span>
                            <span class="n">extra_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_labels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                            <span class="n">extra_fun</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_to_string</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
                            <span class="n">extra_orig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_fun</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">extra_tree</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">extra_tree</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">extra_fun</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">extra_orig</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">extra_orig</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">extra_tree</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">extra_tree</span><span class="p">))</span>
        <span class="n">extra_fun</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">extra_fun</span><span class="p">))</span>
        <span class="n">extra_orig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">extra_orig</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of extra trees for&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">))</span>
    <span class="n">extra_fun</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">extra_orig</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">extra_orig</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">all_fun</span><span class="p">,</span> <span class="n">all_tree</span><span class="p">,</span> <span class="n">extra_fun</span><span class="p">,</span> <span class="n">extra_tree</span><span class="p">,</span> <span class="n">extra_orig</span></div>


<div class="viewcode-block" id="labels_to_shape"><a class="viewcode-back" href="../../api.html#generation.generator.labels_to_shape">[docs]</a><span class="k">def</span> <span class="nf">labels_to_shape</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the representation of the shape of a tree given its labels</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :labels (list): list of strings giving node labels of tree</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :s (str): string comprised of 0, 1 and 2 representing tree of nullary, unary and binary nodes</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">basis_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">basis_functions</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">basis_dict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()):</span>
                <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="aifeyn_complexity"><a class="viewcode-back" href="../../api.html#generation.generator.aifeyn_complexity">[docs]</a><span class="k">def</span> <span class="nf">aifeyn_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute contribution to description length from describing tree</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :tree (list): list of strings giving node labels of tree</span>
<span class="sd">        :param_list (list): list of strings of all possible parameter names</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :aifeyn (float): the contribution to description length from describing tree</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span> <span class="k">if</span> <span class="p">(</span><span class="n">tt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tt</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())]</span>  <span class="c1"># Operators</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tree</span> <span class="k">if</span> <span class="n">tt</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>  <span class="c1"># Integers</span>
    <span class="n">n</span><span class="p">[</span><span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># So we have log(1) for 0 instead of log(0)</span>
    <span class="n">has_param</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>  <span class="c1"># Has either an a0 or an integer</span>
    <span class="n">nop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">+</span> <span class="n">has_param</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nop</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span></div>


<div class="viewcode-block" id="generate_equations"><a class="viewcode-back" href="../../api.html#generation.generator.generate_equations">[docs]</a><span class="k">def</span> <span class="nf">generate_equations</span><span class="p">(</span><span class="n">compl</span><span class="p">,</span> <span class="n">basis_functions</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate all equations at a given complexity for a set of basis functions and save results to file</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :compl (int): complexity of functions to consider</span>
<span class="sd">        :basis_functions (list): list of lists basis functions. basis_functions[0] are nullary, basis_functions[1] are unary and basis_functions[2] are binary operators</span>
<span class="sd">        :dirname (str): directory path to save results in</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :all_fun (list): list of strings containing all functions generated</span>
<span class="sd">        :extra_orig (list): list of strings containing functions generated by combining sums, exponentials and powers of the functions in all_fun as they appear in all_fun</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shapes</span> <span class="o">=</span> <span class="n">get_allowed_shapes</span><span class="p">(</span><span class="n">compl</span><span class="p">)</span>

    <span class="n">nfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">nfun</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_functions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shapes</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">nfun</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Number of topologies:&#39;</span><span class="p">,</span> <span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="nb">int</span><span class="p">(</span><span class="n">nfun</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
    <span class="n">nfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nfun</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Original number of trees:&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">nfun</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">all_fun</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
    <span class="n">extra_fun</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
    <span class="n">extra_orig</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

    <span class="c1"># Clear the files</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orig_trees&#39;</span><span class="p">,</span> <span class="s1">&#39;extra_trees&#39;</span><span class="p">,</span> <span class="s1">&#39;orig_aifeyn&#39;</span><span class="p">,</span> <span class="s1">&#39;extra_aifeyn&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">compl</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">ntree</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nextratree</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%i</span><span class="s1"> of </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">all_fun</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">all_tree</span><span class="p">,</span> <span class="n">extra_fun</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">extra_tree</span><span class="p">,</span> <span class="n">extra_orig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape_to_functions</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">basis_functions</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ntree</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tree</span><span class="p">)</span>
            <span class="n">nextratree</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_tree</span><span class="p">)</span>

        <span class="n">max_param</span> <span class="o">=</span> <span class="n">simplifier</span><span class="o">.</span><span class="n">get_max_param</span><span class="p">(</span><span class="n">all_fun</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_param</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fun</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tree</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_tree</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_orig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_fun</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tree</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_tree</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/orig_trees_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="n">compl</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tree</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/extra_trees_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="n">compl</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="mi">80</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">extra_tree</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/orig_aifeyn_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="n">compl</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">all_tree</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">aifeyn_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">param_list</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dirname</span> <span class="o">+</span> <span class="s1">&#39;/extra_aifeyn_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="n">compl</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">extra_tree</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">aifeyn_complexity</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">param_list</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;cat </span><span class="si">%s</span><span class="s1">/orig_trees_</span><span class="si">%i</span><span class="s1">.txt </span><span class="si">%s</span><span class="s1">/extra_trees_</span><span class="si">%i</span><span class="s1">.txt &gt; </span><span class="si">%s</span><span class="s1">/trees_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">,</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">,</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;cat </span><span class="si">%s</span><span class="s1">/orig_aifeyn_</span><span class="si">%i</span><span class="s1">.txt </span><span class="si">%s</span><span class="s1">/extra_aifeyn_</span><span class="si">%i</span><span class="s1">.txt &gt; </span><span class="si">%s</span><span class="s1">/aifeyn_</span><span class="si">%i</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">,</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">,</span><span class="n">dirname</span><span class="p">,</span><span class="n">compl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ntree:&#39;</span><span class="p">,</span> <span class="n">ntree</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nextratree:&#39;</span><span class="p">,</span> <span class="n">nextratree</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sum:&#39;</span><span class="p">,</span> <span class="n">ntree</span> <span class="o">+</span> <span class="n">nextratree</span><span class="p">)</span>

    <span class="n">all_fun</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">all_fun</span><span class="p">))</span>
    <span class="n">extra_fun</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">extra_fun</span><span class="p">))</span>
    <span class="n">extra_orig</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">extra_orig</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">all_fun&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fun</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;extra_fun&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_fun</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;extra_orig&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_orig</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">all_fun</span> <span class="o">=</span> <span class="n">all_fun</span> <span class="o">+</span> <span class="n">extra_fun</span>
    
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">New number of trees:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_fun</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">all_fun</span><span class="p">,</span> <span class="n">extra_orig</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Deaglan Bartlett.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>